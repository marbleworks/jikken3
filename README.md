# jikken3 ライントレースロボット

Arduino Uno と 3 つのフォトリフレクタを用いて、黒いラインを追従する自律走行ロボットのためのファームウェアです。往復・Uターン・周回の 3 モードに対応し、ラインロスト時の自動復帰や端点判定など競技で必要となる制御ロジックを備えています。

## ハードウェア要件
- Arduino Uno
- フォトリフレクタ（LBR127HLD） ×3（左・中央・右）
- モータドライバ TA7291P
- DC ギヤドモータ（左右独立駆動）
- 可変抵抗（モード選択用、A5 接続）
- センサ状態表示用 LED（任意）

ピンアサインは `leader/pins.h` を参照し、配線に合わせて定数を調整してください。既定では A0/A1/A2 にセンサ、7–10/5–6 にモータ制御、2–4 に LED を割り当てています。

## リポジトリ構成
```
.
├── leader/            # Arduino スケッチと関連モジュール
│   ├── leader.ino     # メインの状態遷移とライン追従ロジック
│   ├── sensors.*      # フォトリフレクタの読み取りと補助関数
│   ├── wheel_control.*# モータ制御ラッパー
│   ├── run_mode.*     # 走行モード管理と可変抵抗入力
│   └── ...
├── rule_linetrace.md  # 競技ルールまとめ
├── follower/          # 距離追従ロボット用のサンプルスケッチ
└── README.md
```

## 開発環境セットアップ
1. Arduino IDE または arduino-cli をインストールする。
2. IDE で `leader/leader.ino` を開き、ボードに **Arduino Uno** を選択する。
3. シリアルモニタは 115200 bps を想定しています。ログを確認する場合は同設定で接続してください。
4. 必要に応じて `leader/pins.h` のピン定義を環境に合わせて変更します。
5. 「検証 / 書き込み」でファームウェアをボードに転送します。

## 距離追従サンプル `follower`

`follower/follower.ino` には、超音波距離センサ HC-SR04 と IR 障害物センサ SSR1017 を組み合わせて前方の対象物を一定距離で追従す
る制御例を収録しています。TA7291P モータドライバ 2 個で左右モータを駆動する想定です。

- 追従距離 (`TARGET_DISTANCE_CM`) や比例・微分ゲイン (`KP` / `KD`) を調整することで、対象との間隔維持性能を最適化できます。
- SSR1017 が LOW を出力した場合は緊急停止し、障害物がクリアされるまで待機します。
- HC-SR04 の測距値が一定時間更新されないと停止するフェイルセーフを備えています。

ピン定義はスケッチ冒頭の定数を変更して環境に合わせてください。PWM の最大値 (`MAX_PWM`) やデッドゾーン補正 (`DEAD_PWM`) もモ
ータ特性に応じて調整可能です。

## 走行モードの選択
`leader/leader.ino` は競技ごとに異なる走行方針を切り替えられる `RunMode` を提供します。

| モード | 想定競技 | 動作概要 |
| :-- | :-- | :-- |
| `RUNMODE_RECIP` | 直線コース往復1 | 往路前進 → 復路は向きを変えずに後退 |
| `RUNMODE_UTURN` | 直線コース往復2 | 往路前進 → 端点で 180° 回頭 → 復路前進 |
| `RUNMODE_LOOP` | 周回コース | 端点で停止せず、周回走行を継続 |

選択方法は 2 通りあります。

- **コンパイル時既定値**: `leader/run_mode.h` の `COMPILE_TIME_RUNMODE` を書き換えてビルドします。
- **可変抵抗入力**: `leader/run_mode_pot.ino` のロジックで A5 に接続した可変抵抗を読み取り、起動時に 3 分割の電圧域でモードを切り替えます。利用しない場合は `RUNMODE_POT_ENABLED` を `false` に設定してください。

起動時には選択されたモード名がシリアルログに出力され、現在の設定を確認できます。

## チューニングパラメータ
`leader/leader.ino` の冒頭には以下のような走行特性を左右する定数がまとまっています。

- `THRESHOLD` / `HYST`: 黒白判定の境界とヒステリシス。
- `BASE_FWD` / `BASE_BACK`: 前進・後退時の基準 PWM。
- `KP_FWD` / `KP_BACK`（＋ `KI_*`, `KD_*`）: 比例・積分・微分ゲイン。ライン中心からのずれに対する補正量を調整します。
- `MAX_PWM` / `MIN_PWM`: PWM の出力上限 / 下限。
- `SEEK_SPEED`: 端点スタート時にラインを探索する速度。
- 端点検出: `ENDPOINT_BLACK_HOLD_MS`（直前に黒を見続けた最小時間）、`ENDPOINT_BLACK_ACC_MIN`（その間の黒強度累積）、`ENDPOINT_WHITE_HOLD_MS`（全白継続時間）。
- ラインロスト検出: `LOST_RECENT_BLACK_MS`（直近の黒を有効とみなす時間窓）、`LOST_DROP_THRESHOLD` / `LOST_MIN_BLACK_LEVEL`（濃淡の急減判定）、`LOST_WHITE_HOLD_MS`（全白継続時間）。
- `REC_STEER`: ラインロスト復帰時の旋回強度。
- `UTURN_SPEED`, `UTURN_TIME_MS`: U ターン時の片輪駆動速度と持続時間。

調整時は一度に 1 パラメータずつ変更し、シリアルモニタやセンサ表示 LED (`leader/sensor_leds.*`) を活用して挙動を確認することを推奨します。

## ラインロストとリカバリ
ライン追従中は原センサ値から「黒ピークの急減（`LOST_DROP_THRESHOLD` と `LOST_MIN_BLACK_LEVEL`）」を検出し、一定時間（`LOST_WHITE_HOLD_MS`）全白が継続した場合にラインロストとしてリカバリ状態へ移行します。ドロップの検知フェーズと全白の確定フェーズはシリアルログに `Line drop (FOLLOW/RECOVER)`、`Line lost via white hold (...)` と出力されるため、現場でどちらの経路でロストしたか確認できます。直前に黒を検知していた側 (`getBlackDirState`) を記録しており、その方向へ旋回しながらライン復帰を試みます。方向が不明な場合は時間で左右を切り替え、復帰を試みます。復帰に成功すると通常の追従状態へ戻ります。

## テスト手順（端点 / ラインロストの切り分け）

新しい端点・ラインロスト検出ロジックを確認する際は、以下の手順を推奨します。いずれもシリアルモニタを 115200 bps で開き、ログを観察しながら実施してください。

1. **端点検証**
   - コース上で通常の走行を行い、端点直前で黒ラインを十分に踏んでから全白エリアに進入させます。
   - ログに `Endpoint detected (FOLLOW)` または `Endpoint detected (RECOVER)` が出力され、同時に `Line drop` / `Line lost` が出力されないことを確認します。
2. **ラインロスト検証（意図的にラインから外す）**
   - 走行中に車体を手で持ち上げる、もしくはコース外へ逸らし、センサ値を急激に白へ変化させます。
   - `Line drop (FOLLOW)` → `Line lost via white hold (FOLLOW)` の順でログが出力され、`Endpoint detected` が出ないことを確認します。
3. **リカバリ中の挙動確認**
   - ラインロスト後に車体を戻し、リカバリで再捕捉させます。
   - ログに `Line drop (RECOVER)` が継続して出ないこと（再捕捉時は黒検出でリセットされる）と、端点へ進入した場合は `Endpoint detected (RECOVER)` が出力されることを確認します。

これら 3 ケースを通じて、端点判定とラインロスト判定が相互に干渉せず、ログから経路を容易に判別できることを確認できます。

## センサ・LED の利用
`sensors.ino` では 3 センサの RAW 値と黒判定フラグを `Sense` 構造体で扱います。`sensor_leds.ino` を有効にすると、黒を検知したセンサに対応する LED を点灯させられ、現場でのデバッグが容易になります。

## 競技ルールの要点
詳細な採点基準や進行は `rule_linetrace.md` を参照してください。直線コース往復 2 では端点でのライン逸脱が一時的に許可されるなど、モード選択や U ターン挙動の調整に影響する注意点がまとまっています。

## ログとデバッグのコツ
- **シリアルログ**: 状態遷移や端点検出は `Serial.println` で出力しています。ログを読みながら挙動を把握しましょう。
- **タイマー**: `leader/timer.h` でシンプルな経過時間測定を行っています。必要であればラップ時間計測など追加可能です。
- **安全対策**: パラメータ調整時は車体を浮かせた状態でホイールを回し、急激な出力が掛からないか確認してから本番コースで試走してください。

## ライセンス
本リポジトリのライセンスはリポジトリの管理者に確認してください。
