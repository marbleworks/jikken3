# Follower - 追従機

先導機の後方パネルを超音波センサで検出し、追従する車両。

## 制御方式

左右の超音波センサで先導機を検出し、検出状態に応じて旋回する。

```
右センサ検出 → +1
左センサ検出 → -1
合計値(turnDirection)で旋回方向を決定
```

| 左センサ | 右センサ | turnDirection | 動作 |
|----------|----------|---------------|------|
| 検出 | 検出 | 0 | 直進 |
| 見失い | 見失い | 0 | 直進 |
| 検出 | 見失い | -1 | 左旋回 |
| 見失い | 検出 | +1 | 右旋回 |

## ハードウェア構成

### センサ
- **超音波センサ (HC-SR04)** x2: 左右に配置、先導機までの距離を測定
- **赤外線障害物センサ** x1: 前方障害物検出（検出時は停止）
- **LCD (ACM0802C-NLW-BBH)**: 8x2文字、センサ値表示用

### アクチュエータ
- **DCモーター** x2: 左右独立駆動

## ピン配置

| 機能 | ピン |
|------|------|
| IR障害物センサ | D2 |
| 左モーター PWM | D3 |
| 左モーター IN1 | D4 |
| 左モーター IN2 | D5 |
| 右モーター PWM | D6 |
| 右モーター IN1 | D7 |
| 右モーター IN2 | D8 |
| 左超音波 TRIG | D9 |
| 左超音波 ECHO | D10 |
| 右超音波 TRIG | D11 |
| 右超音波 ECHO | D12 |
| LCD RS | A0 |
| LCD E | A1 |
| LCD D4-D7 | A2-A5 |

## パラメータ

### 制御パラメータ

| パラメータ | デフォルト値 | 説明 |
|------------|--------------|------|
| `BASE_PWM` | 100 | 直進時の基準PWM |
| `TURN_PWM` | 50 | 旋回時のPWM差分 |
| `LOST_THRESHOLD_CM` | 30.0 | 見失い判定の閾値 (cm) |
| `MAX_DISTANCE_CM` | 40.0 | センサ最大検出距離 (cm) |

### タイミングパラメータ

| パラメータ | デフォルト値 | 説明 |
|------------|--------------|------|
| `SONAR_INTERVAL_MS` | 60 | センサ読み取り間隔 (ms) |
| `LCD_UPDATE_MS` | 200 | LCD更新間隔 (ms) |
| `MOVING_AVG_SIZE` | 5 | 移動平均フィルタのサンプル数 |

### モーターパラメータ

| パラメータ | デフォルト値 | 説明 |
|------------|--------------|------|
| `MIN_PWM` | 0 | PWM下限 |
| `MAX_PWM` | 255 | PWM上限 |
| `DEAD_PWM` | 30 | デッドゾーン（これ以下は出力しない） |

## コンパイルフラグ

| フラグ | デフォルト | 説明 |
|--------|-----------|------|
| `SERIAL_PLOTTER_PRINT` | 1 | Serial Plotter出力の有効/無効 |

## ファイル構成

```
follower/
├── follower.ino          # メインループ
├── pins.h                # ピン定義
├── distance_sensor.h/cpp # 超音波センサ
├── obstacle_sensor.h/cpp # IR障害物センサ
├── wheel_control.h/cpp   # モーター制御
├── lcd_display.h/cpp     # LCD表示
└── moving_average.h      # 移動平均フィルタ
```

## 処理フロー

```
loop() [60ms周期]
  │
  ├─ センサ読み取り
  │   ├─ モーター一時停止 (ノイズ対策)
  │   ├─ 左超音波センサ読み取り
  │   ├─ 5ms待機 (干渉防止)
  │   ├─ 右超音波センサ読み取り
  │   └─ 移動平均フィルタ適用
  │
  ├─ LCD更新 [200ms周期]
  │
  ├─ 制御判定
  │   ├─ 左右の検出状態を判定
  │   └─ turnDirection = rightDetect - leftDetect
  │
  └─ モーター制御
      ├─ IR検出時 → 停止
      └─ 通常時 → leftPwm/rightPwm計算して駆動
```
